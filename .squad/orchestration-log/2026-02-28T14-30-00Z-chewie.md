# Orchestration Log: Chewie (DevOps/Infra)

**Date:** 2026-02-28T14:30:00Z  
**Agent:** Chewie  
**Role:** DevOps/Infra  
**Status:** Completed  

## Summary

Registered CampLog.Web3 React npm app in Aspire AppHost with unified environment variable wiring and npm script execution, enabling consistent orchestration across three frontend implementations (Web, Web2, Web3).

## Changes Made

### 1. Package Addition
- **Package:** Aspire.Hosting.NodeJs
- **Version:** 9.5.2 (latest available; core Aspire is 13.1.2 on separate release cadence)
- **File:** CampLog.AppHost/CampLog.AppHost.csproj
- **Note:** Version mismatch between NodeJs and core Aspire is known limitation; will track for future upgrade

### 2. AppHost Registration
**File:** CampLog.AppHost/AppHost.cs

**Code added after web2 resource registration:**
```csharp
builder.AddNpmApp("web3", "../CampLog.Web3", "dev")
    .WithReference(api).WaitFor(api)
    .WithEnvironment("VITE_API_BASE_URL", api.GetEndpoint("https"))
    .WithEnvironment("VITE_KEYCLOAK_URL", keycloak.GetEndpoint("http"))
    .WithHttpEndpoint(port: 3000, env: "PORT")
    .PublishAsDockerFile();
```

**Configuration details:**
- **Resource name:** "web3" (appears in Aspire dashboard)
- **Project path:** "../CampLog.Web3" (relative to AppHost)
- **npm script:** "dev" (executes `npm run dev` = Vite dev server)
- **API dependency:** WithReference(api).WaitFor(api) ensures API starts first
- **Environment wiring:**
  - VITE_API_BASE_URL → api.GetEndpoint("https") — Backend HTTPS URL
  - VITE_KEYCLOAK_URL → keycloak.GetEndpoint("http") — Identity provider HTTP URL
- **Port configuration:** WithHttpEndpoint(port: 3000, env: "PORT") declares Vite dev server port
- **Docker support:** PublishAsDockerFile() enables containerization for future deployment

## Operational Impact

✅ Web3 integrates into unified Aspire orchestration  
✅ Automatic startup/shutdown with AppHost (`aspire run`)  
✅ Environment variables injected without manual .env files  
✅ Aspire dashboard monitors Web3 alongside api/web/web2/keycloak/postgres  
✅ Consistent dependency ordering: api + keycloak → web3  

## Build Validation

✅ `dotnet build CampLog.AppHost/CampLog.AppHost.csproj` succeeds  
✅ No compilation errors  
✅ AppHost ready for `aspire run` execution once Web3 npm install completes

## Alternatives Evaluated

1. **Run Web3 standalone:** Rejected — requires manual env var setup and separate startup
2. **Use Aspire.Hosting.NodeJs v13.1.2:** Not available on NuGet; package lags behind core releases
3. **Lambda-based env resolution:** Not needed — direct GetEndpoint() works with current API

## Related Decisions

- `chewie-web3-aspire.md` (inbox → merged to decisions.md)
- Prerequisite: Lando completes Web3 scaffolding with npm package.json including "dev" script
